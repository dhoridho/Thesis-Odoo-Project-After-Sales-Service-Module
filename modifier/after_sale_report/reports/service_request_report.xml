<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="report_service_request_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">

                <div class="page">
                    <!-- Report Header -->
                    <div class="text-center mb-4">
                        <t t-set="report_data" t-value="data.get('form', {}).get('report_data')"/>
                        <t t-set="report_title" t-value="{
                            'service_request': 'Service Request',
                            'warranty_claim': 'Warranty Claim',
                            'sale_return': 'Sale Return'
                        }.get(report_data, 'Report')"/>

                        <div class="text-center mb-4">
                            <h2 class="text-primary" style="font-size: 24px; font-weight: bold;"><t t-esc="report_title"/> Report</h2>
                        </div>
                    </div>

                    <!-- Report Filters Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Report Filters</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-borderless">
                                <tbody>
                                    <tr>
                                        <!-- Date Range -->
                                        <td width="33%" style="vertical-align: top;">
                                            <strong>Date Range:</strong><br/>
                                            <t t-if="data.get('form', {}).get('start_date')">
                                                <span t-esc="data['form']['start_date']" t-options='{"widget": "date"}'/>
                                                <span> to </span>
                                                <span t-esc="data['form']['end_date']" t-options='{"widget": "date"}'/>
                                            </t>
                                            <t t-else="">
                                                <span>All Dates</span>
                                            </t>
                                        </td>

                                        <!-- Filter Type -->
                                        <td width="33%" style="vertical-align: top;">
                                            <strong>Filter Type:</strong><br/>
                                            <t t-if="data.get('form', {}).get('user_type')">
                                                <t t-set="user_type" t-value="{
                                                    'responsible': 'By Customer Service',
                                                    'customer': 'By Customer',
                                                    'both': 'All Types'
                                                }.get(data['form']['user_type'], 'Not Specified')"/>
                                                <span t-esc="user_type"/>
                                            </t>
                                            <t t-else="">
                                                <span>All Types</span>
                                            </t>
                                        </td>

<!--                                        <t t-set="records" t-value="docs or env['service.request'].browse(data.get('ids', []))"/>-->
<!--                                        <t t-set="report_data" t-value="data.get('form', {}).get('report_data')"/>-->
<!--                                        <t t-set="model_name" t-value="{-->
<!--                                            'service_request': 'service.request',-->
<!--                                            'warranty_claim': 'warranty.claim',-->
<!--                                            'sale_return': 'sale.return'-->
<!--                                        }.get(report_data, 'warranty.claim')"/>-->

                                        <t t-if="report_title == 'Service Request'">
                                            <t t-set="records" t-value="docs or env['warranty.claim'].browse(data.get('ids', []))"/>
                                        </t>
                                        <t t-if="report_title == 'Warranty Claim'">
                                            <t t-set="records" t-value="docs or env['warranty.claim'].browse(data.get('ids', []))"/>
                                        </t>
                                        <t t-if="report_title == 'Sale Return'">
                                            <t t-set="records" t-value="docs or env['sale.return'].browse(data.get('ids', []))"/>
                                        </t>

                                         <t t-if="report_title != 'Sale Return'">
                                            <t t-set="filtered_records" t-value="records.filtered(lambda r: (user_type == 'All Types') or (user_type == 'By Customer Service' and not r.is_by_portal) or (user_type == 'By Customer' and r.is_by_portal))"/>
                                        </t>
                                        <t t-else="">
                                            <t t-set="filtered_records" t-value="records"/>
                                        </t>



                                        <!-- Responsible -->
                                        <td width="33%" style="vertical-align: top;">
                                            <t t-if="data.get('form', {}).get('responsible_id', False)">
                                                <strong>Responsible:</strong><br/>
                                                <span t-esc="env['res.users'].browse(data['form']['responsible_id']).name"/>
                                            </t>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Report Summary -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Total <span t-esc="report_title"/>s: </strong>
                                <span t-esc="len(filtered_records)"/>
                            </div>
                            <!--                            <div>-->
                            <!--                                <strong>Period Coverage: </strong>-->
                            <!--                                &lt;!&ndash;                                <span t-esc="(data.get('form', {}).get('start_date') and format_date(data['form']['start_date']) + ' to ' + format_date(data['form']['end_date']) or 'All Time'"/>&ndash;&gt;-->
                            <!--                                <t t-set="date_range" t-value="data.get('form', {}).get('start_date') and (format_date(data['form']['start_date']) + ' to ' + format_date(data['form']['end_date'])) or 'All Time'"/>-->
                            <!--                                <span t-esc="date_range"/>-->
                            <!--                            </div>-->
                        </div>
                    </div>

                    <!-- Report Data Table -->
                    <div>
                        <t t-if="report_title != 'Sale Return'">
                            <table class="table table-striped table-bordered">
                            <thead class="thead-dark">
                                <tr>
                                    <th class="text-center">#</th>
                                    <th>Request No.</th>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Customer Service</th>
                                    <th>Status</th>
                                    <th class="text-center">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="filtered_records" t-as="request">
                                    <tr>
                                        <td class="text-center" t-esc="request_index + 1"/>
                                        <td>
                                            <span t-field="request.name" style="font-weight: 500;"/>
                                        </td>
                                        <td>
                                            <span t-field="request.partner_id.name"/>
                                        </td>
                                        <td>
                                            <span t-field="request.product_id.name"/>
                                        </td>
                                        <td>
                                            <span t-field="request.responsible_id.name"/>
                                        </td>
                                        <td>
                                            <span t-att-class="'badge badge-' +
                                                {'draft': 'secondary',
                                                 'confirmed': 'info',
                                                 'in_progress': 'primary',
                                                 'done': 'success',
                                                 'cancel': 'danger'}.get(request.state, 'light')"
                                                  t-esc="request.state.upper()"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-field="request.create_date" t-options='{"widget": "date"}'/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                        </t>
                        <t t-else="">
                            <table class="table table-striped table-bordered">
                            <thead class="thead-dark">
                                <tr>
                                    <th class="text-center">#</th>
                                    <th>Return No.</th>
                                    <th>Customer</th>
                                    <th>Order No.</th>
                                    <th>Customer Service</th>
                                    <th>Status</th>
                                    <th class="text-center">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="filtered_records" t-as="request">
                                    <tr>
                                        <td class="text-center" t-esc="request_index + 1"/>
                                        <td>
                                            <span t-field="request.name" style="font-weight: 500;"/>
                                        </td>
                                        <td>
                                            <span t-field="request.partner_id.name"/>
                                        </td>
                                        <td>
                                            <span t-field="request.sale_id.name"/>
                                        </td>
                                        <td>
                                            <span t-field="request.user_id.name"/>
                                        </td>
                                        <td>
                                            <span t-att-class="'badge badge-' +
                                                {'draft': 'secondary',
                                                 'confirmed': 'info',
                                                 'process': 'primary',
                                                 'close': 'success',
                                                 'reject': 'danger'}.get(request.state, 'light')"
                                                  t-esc="request.state.upper()"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-field="request.create_date" t-options='{"widget": "date"}'/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                        </t>


                    </div>

                    <!-- Report Footer -->
                    <!--                    <div class="mt-4 text-right">-->
                    <!--                        <small class="text-muted">-->
                    <!--                            Printed by: <span t-esc="env.user.name"/> on <span t-esc="format_date(fields.Date.today())"/>-->
                    <!--                        </small>-->
                    <!--                    </div>-->
                </div>
            </t>
        </t>
    </template>
</odoo>