<templates>
    <t t-name="ProductionReportTemplate">
        <div class="o_view_production_report">
            <div class="o_mining_production_report_header"></div>
            <div class="o_mining_production_report_content">
            </div>
        </div>
    </t>
    
    <t t-name="ProductionReportHeader">
        <div class="o_mining_report_title">
            <h1>Production Report</h1>
        </div>

        <div class="o_mining_control_panel">
            <div class="o_panel_left">
                <div class="o_report_buttons">
                    <button type="button" class="o_print_pdf btn btn-primary mr-2">Print (PDF)</button>
                    <button type="button" class="o_print_xlsx btn btn-primary" id="xlsx">Export (XLSX)</button>
                </div>
            </div>
            <div class="o_panel_right">
                <div class="o_report_filter">
                    <div class="o_filter mr-2">
                        <div class="dropleft o_filter_date">
                            <t t-set="filter_date" t-value="filters['filter_date']"/>
                            <a class="btn btn-secondary dropdown-toggle o_filter_date_btn" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" t-att-data-filter-date="filter_date['active'][0]">
                                <t t-esc="filter_date['active'][1]"/>
                            </a>
                            <ul class="dropdown-menu o_filter_date_dropdown" aria-labelledby=".o_filter_date_btn">
                                <t t-foreach="filter_date['selection']" t-as="selection">
                                    <t t-if="selection[0] != 'custom'">
                                        <t t-if="selection[0] == 'last_month'">
                                            <li class="dropdown-divider"></li>
                                        </t>
                                        <li><a class="dropdown-item o_filter_date_item" href="#" t-att-data-filter-date="selection[0]">
                                            <t t-esc="selection[1]"/>
                                        </a></li>
                                    </t>
                                </t>
                                <li class="dropdown-divider"></li>
                                <li class="o_filter_date_custom">
                                    <a class="dropdown-item o_filter_date_custom_btn" data-toggle="collapse" href="#" role="button" aria-expanded="false">
                                        Custom
                                    </a>
                                    <div class="collapse o_filter_date_custom_collapse">
                                        <div class="o_filter_date_custom_container">
                                            <div class="o_custom_date_from"></div>
                                            <div class="o_custom_date_to mt-2"></div>
                                            <button class="btn btn-sm btn-secondary w-100 mt-2 o_apply_custom_date">Apply</button>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="o_apply">
                        <button type="button" class="o_apply_filter btn btn-primary">Apply</button>
                    </div>
                </div>
            </div>
        </div>
    </t>

    <t t-name="ProductionReportTable">

        <table class="table o_table_production_report">

            <t t-foreach="data['children']" t-as="site">
                <thead>
                    <tr>
                        <th rowspan="2" class="o_title o_freeze"><t t-esc="site['name']"/></th>
                        <t t-foreach="months" t-as="month">
                            <th colspan="4" class="o_month"><t t-esc="month"/></th>
                        </t>
                        <th colspan="4" class="o_month">Total</th>
                    </tr>
                    <tr>
                        <t t-foreach="months">
                            <th class="o_value o_left_border">Planned</th>
                            <th class="o_value">Actual</th>
                            <th class="o_value">Achievement (%)</th>
                            <th class="o_value">UoM</th>
                        </t>
                        <th class="o_value o_left_border">Planned</th>
                        <th class="o_value">Actual</th>
                        <th class="o_value">Achievement (%)</th>
                        <th class="o_value">UoM</th>
                    </tr>
                </thead>

                <t t-foreach="site['children']" t-as="operation">
                    <tbody class="o_row" data-toggle="collapse" t-attf-data-target=".row_{{site['id']}}_{{operation['id']}}" aria-expanded="false">
                        <tr>
                            <td class="o_freeze">
                                <span class="fa fa-caret-right" role="img" aria-label="Unfolded" title="Unfolded"></span>
                                <t t-esc="operation['name']"/>
                            </td>

                            <t t-set="total_operation_planned" t-value="0.0"/>
                            <t t-set="total_operation_actual" t-value="0.0"/>
                            <t t-foreach="operation['months']" t-as="operation_month">
                                <td class="o_value o_left_border"><t t-esc="formatFloat(operation_month_value['planned'])"/></td>
                                <td class="o_value"><t t-esc="formatFloat(operation_month_value['actual'])"/></td>
                                <td class="o_value"><t t-esc="formatFloat(operation_month_value['achievement'])"/></td>
                                <td class="o_value"><t t-esc="operation['uom_name']"/></td>

                                <t t-set="total_operation_planned" t-value="total_operation_planned + operation_month_value['planned']"/>
                                <t t-set="total_operation_actual" t-value="total_operation_actual + operation_month_value['actual']"/>
                            </t>

                            <td class="o_value o_total o_left_border"><t t-esc="formatFloat(total_operation_planned)"/></td>
                            <td class="o_value o_total"><t t-esc="formatFloat(total_operation_actual)"/></td>
                            <td t-if="total_operation_planned > 0.0" class="o_value o_total"><t t-esc="formatFloat((total_operation_actual / total_operation_planned) * 100)"/></td>
                            <td t-else="" class="o_value o_total"><t t-esc="formatFloat(0.0)"/></td>
                            <td class="o_value o_total"><t t-esc="operation['uom_name']"/></td>
                        </tr>
                    </tbody>
                    <tbody t-attf-class="collapse row_{{site['id']}}_{{operation['id']}}">
                        <t t-foreach="operation['children']" t-as="act">
                            <tr>
                                <td class="o_act o_freeze">
                                    <div class="dropdown o_record">
                                        <a class="o_record_dropdown dropdown-toggle" data-toggle="dropdown" href="#" aria-haspopup="true" aria-expanded="false">
                                            <span t-esc="act['name']"/>
                                        </a>
                                        <ul class="dropdown-menu" aria-labelledby=".o_record_dropdown">
                                            <li>
                                                <a class="dropdown-item o_view_record" href="#" 
                                                t-att-data-name="act['name']" 
                                                t-att-data-model="act['model']" 
                                                t-att-data-res_id="act['id']">
                                                    View Record
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                                <t t-set="total_act_planned" t-value="0.0"/>
                                <t t-set="total_act_actual" t-value="0.0"/>
                                <t t-foreach="act['months']" t-as="act_month">
                                    <td class="o_value o_left_border"><t t-esc="formatFloat(act_month_value['planned'])"/></td>
                                    <td class="o_value"><t t-esc="formatFloat(act_month_value['actual'])"/></td>
                                    <td class="o_value"><t t-esc="formatFloat(act_month_value['achievement'])"/></td>
                                    <td class="o_value"><t t-esc="act['uom_name']"/></td>

                                    <t t-set="total_act_planned" t-value="total_act_planned + act_month_value['planned']"/>
                                    <t t-set="total_act_actual" t-value="total_act_actual + act_month_value['actual']"/>
                                </t>
                                <td class="o_value o_total o_left_border"><t t-esc="formatFloat(total_act_planned)"/></td>
                                <td class="o_value o_total"><t t-esc="formatFloat(total_act_actual)"/></td>
                                <td t-if="total_act_planned > 0.0" class="o_value o_total"><t t-esc="formatFloat((total_act_actual / total_act_planned) * 100)"/></td>
                                <td t-else="" class="o_value o_total"><t t-esc="formatFloat(0.0)"/></td>
                                <td class="o_value o_total"><t t-esc="act['uom_name']"/></td>
                            </tr>
                        </t>
                    </tbody>
                </t>
            </t>
        </table>
    </t>

</templates>