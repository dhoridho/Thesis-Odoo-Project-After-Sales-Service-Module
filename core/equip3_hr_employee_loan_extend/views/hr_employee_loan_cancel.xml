<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_loan_cancel_tree" model="ir.ui.view">
            <field name="name">employee.loan.cancelation.tree</field>
            <field name="model">employee.loan.cancelation</field>
            <field name="arch" type="xml">
                <tree string="Loans">
                    <field name="name"/>
                    <field name="date_applied"/>
                    <field name="loan_type"/>
                    <field name="employee_id"/>
                    <field name="int_payable" invisible="1"/>
                    <field name="interest_mode" invisible="1"/>
                    <field name="date_approved"/>
                    <field name="principal_amount"/>
                    <field name="int_rate"/>
                    <field name="final_total"/>
                    <field name="total_amount_paid"/>
                    <field name="total_amount_due"/>
                    <field name="state" decoration-primary="state == 'draft'"
                            decoration-warning="state == 'to_approve'"
                            decoration-success2="state == 'paid'" 
                            decoration-success3="state == 'disburse'" 
                            decoration-secondary="state == 'cancel'"
                            decoration-danger="state == 'rejected'" 
                            widget='badge'/>
                    <field name="company_id" groups="base.group_multi_company"/>
                </tree>
            </field>
        </record>

        <record id="view_loan_cancel_form" model="ir.ui.view">
            <field name="name">employee.loan.cancelation.form</field>
            <field name="model">employee.loan.cancelation</field>
            <field name="arch" type="xml">
                <form string="Loan" version="7.0">
                    <header>
                        <button name="action_confirm" string="Confirm" type="object"
                                groups="hr.group_hr_user" class="oe_highlight" states="draft"/>
                        <button name="wizard_approve" string="Approve" type="object"
                                groups="hr.group_hr_user" class="oe_highlight"
                                attrs="{'invisible': ['|', ('is_approver', '=', False), ('state', '!=', 'to_approve')]}"/>
                        <button name="wizard_reject" string="Reject" type="object"
                                groups="hr.group_hr_user,account.group_account_invoice" class="oe_highlight"
                                attrs="{'invisible': ['|', ('is_approver', '=', False), ('state', '!=', 'to_approve')]}"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,applied,approved" attrs="{'invisible':[('is_loan_approval_matrix','=',False)]}"/>
                        <field name="state1" widget="statusbar" statusbar_visible="draft,approved" attrs="{'invisible':[('is_loan_approval_matrix','!=',False)]}"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <label for="employee_id" class="oe_edit_only"/>
                            <h1>
                                <field name="employee_id" options="{'no_quick_create':True,'no_create_edit':True,'no_open': True,'no_create': True}" attrs="{'readonly':['|',('is_readonly','=',True),('state','not in','draft')]}" domain="[('id','in',domain_employee_ids)]"/>
                                <field name="is_readonly" invisible="1"/>
                                <field name="domain_employee_ids" invisible="1"/>
                            </h1>
                            <label for="name" class="oe_edit_only"/>
                            <h2>
                                <field name="name"/>
                            </h2>
                        </div>
                        <group>
                            <group>
                                <field name="loan_id" attrs="{'readonly':['|',('is_readonly','=',True),('state','not in','draft')]}"/>
                                <field name="date_applied" force_save="1"/>
                                <field name="loan_type" widget="selection"
                                       on_change="onchange_loan_type(loan_type, employee_id)" force_save="1"/>

                            </group>
                            <group>
                                <field name="date_approved" force_save="1"/>
                                <field name="date_disb"
                                       groups="account.group_account_invoice" force_save="1"/>
                                <field name="department_id" force_save="1"/>
                                <field name="company_id" groups="base.group_multi_company"
                                       widget="selection" force_save="1"/>
                                <field name="user_id" force_save="1"/>
                                <field name="approvers_ids" widget="many2many_tags" invisible="1" force_save="1"/>
                                <field name="approved_user_ids" widget="many2many_tags" invisible="1" readonly="0" force_save="1"/>
                                <field name="is_approver" invisible="1" force_save="1"/>
                                <field name="approved_user_text" invisible="1" force_save="1"/>
                                <field name="approved_user" invisible="1" readonly="0" force_save="1"/>
                                <field name="job_id" invisible="1" force_save="1"/>
                                <field name="department_id" invisible="1" force_save="1"/>
                                <field name="feedback_parent" invisible="1" force_save="1"/>
                                <field name="is_loan_approval_matrix" invisible="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="General">
                                <group>
                                    <field name="currency_id" groups="base.group_multi_currency" force_save="1"/>
                                    <field name="principal_amount" widget="monetary"
                                           options="{'currency_field': 'currency_id'}" force_save="1"/>
                                    <field name="int_payable" force_save="1"/>
                                    <field name="interest_mode" force_save="1"/>
                                    <field name="duration" force_save="1"/>
                                    <field name="employee_gross" groups="hr.group_hr_user,hr.group_hr_manager"
                                           required="False" invisible="1" force_save="1"/>
                                    <field name="int_rate" force_save="1"/>
                                    <field name="max_loan_amt" invisible="1"
                                           attrs="{'invisible':[('state','in',['draft','cancel'])]}" force_save="1"/>
                                </group>
                                <newline/>
                                <field name="installment_lines" readonly="1" nolabel="1">
                                    <tree editable="top" string="Installments">
                                        <field name="install_no" force_save="1"/>
                                        <field name="date_from" force_save="1"/>
                                        <field name="date_to" force_save="1"/>
                                        <field name="principal_amt" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" sum="Principal" force_save="1"/>
                                        <field name="interest_amt" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" sum="Interest" force_save="1"/>
                                        <field name="total" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" sum="Total" force_save="1"/>
                                        <field name="state" force_save="1"/>
                                        <field name="currency_id" groups="base.group_multi_currency" force_save="1"/>
                                        <field name="int_move_id" invisible="1" force_save="1"/>
                                        <!-- <button name="pay_installment"
                                                confirm="You are trying to create EMI for this loan so make sure loan repayment for this loan type is not from payroll !"
                                                states="approve" string="Pay" type="object"
                                                help="Pay Installment"/>
                                        <button name="book_interest"
                                                attrs="{'invisible':['|', ('interest_amt', '=', 0.0), ('int_move_id', '!=', False)]}"
                                                type="object"
                                                string="Book Interest"
                                                help="Book Interest"/>


                                        <button name="action_approve" states="unpaid" string="Approve Payment"
                                                type="object" help="Approve Payment"/>
                                        <button name="action_reset" states="approve" string="Reset To Draft"
                                                type="object" help="Reset To Draft"/> -->
                                    </tree>
                                </field>
                                <group>
                                    <group>
                                        <field name="final_total" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                        <field name="total_interest_amount" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                        <field name="total_amount_paid" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                        <field name="total_amount_due" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                    </group>
                                    <newline/>
                                </group>
                            </page>
                            <page string="Proofs">
                                <field name="loan_proof_ids" nolabel="1" readonly="1" force_save="1">
                                    <tree editable="bottom" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="attachment" widget="binary" filename="attachment_name"/>
                                        <field name="attachment_name" invisible="1"/>
                                        <field name="mandatory"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Accounting"
                                  groups="account.group_account_invoice">
                                <group>
                                    <field name="journal_id"
                                           colspan="2" force_save="1"/>
                                    <field name="move_id" colspan="2" force_save="1"/>
                                    <field name="journal_id1" force_save="1"/>
                                    <field name="journal_id2" force_save="1"/>
                                    <field name="employee_loan_account" colspan="2" force_save="1"/>
                                </group>
                            </page>
                            <page string="Policies"
                                  groups="hr.group_hr_user,account.group_account_invoice">
                                <separator string="Policies" colspan="4"/>
                                <field name="loan_policy_ids" nolabel="1" colspan="4" force_save="1"/>
                            </page>
                            <page string="Notes">
                                <field name="notes" colspan="2" nolabel="1" force_save="1"/>
                            </page>
                            <page string="Approval Matrix Lines" attrs="{'invisible':[('is_loan_approval_matrix','=',False)]}">
                                <field name="loan_approver_user_ids">
                                    <tree editable="bottom" create="false" delete="false">
                                        <field name="name" force_save="1"/>
                                        <field name="user_ids" widget="many2many_tags" readonly="1" force_save="1"/>
                                        <field name="matrix_user_ids" widget="many2many_tags" invisible="1" readonly="1" force_save="1"/>
                                        <field name="is_delegation_mail_sent" invisible="1"/>
                                        <field name="minimum_approver" readonly="1" force_save="1"/>
                                        <field name="timestamp" invisible="1" force_save="1"/>
                                        <field name="approver_state" invisible="1" force_save="1"/>
                                        <field name="approval_status" readonly="1" force_save="1"/>
                                        <field name="approved_time" readonly="1" force_save="1"/>
                                        <field name="is_approve" invisible="1" force_save="1"/>
                                        <field name="approved_employee_ids" invisible="1"/>
                                        <field name="feedback" readonly="1" force_save="1"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"
                               groups="base.group_user"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
        <record id="view_loan_cancel_tree_manager" model="ir.ui.view">
            <field name="name">employee.loan.cancelation.tree.manager</field>
            <field name="model">employee.loan.cancelation</field>
            <field name="arch" type="xml">
                <tree string="Loans" create="0">
                    <field name="name"/>
                    <field name="date_applied"/>
                    <field name="loan_type"/>
                    <field name="employee_id"/>
                    <field name="int_payable" invisible="1"/>
                    <field name="interest_mode" invisible="1"/>
                    <field name="date_approved"/>
                    <field name="principal_amount"/>
                    <field name="int_rate"/>
                    <field name="final_total"/>
                    <field name="total_amount_paid"/>
                    <field name="total_amount_due"/>
                    <field name="state"
                            decoration-primary="state == 'draft'"
                            decoration-warning="state == 'to_approve'"
                            decoration-success2="state == 'paid'" 
                            decoration-success3="state == 'disburse'" 
                            decoration-secondary="state == 'cancel'"
                            decoration-danger="state == 'rejected'" 
                            widget='badge'/>
                    <field name="company_id" groups="base.group_multi_company"/>
                </tree>
            </field>
        </record>

        <record id="view_loan_cancel_form_manager" model="ir.ui.view">
            <field name="name">employee.loan.cancelation.form.manager</field>
            <field name="model">employee.loan.cancelation</field>
            <field name="arch" type="xml">
                <form string="Loan" version="7.0" create="0">
                    <header>
                        <button name="action_confirm" string="Confirm" type="object"
                                groups="hr.group_hr_user" class="oe_highlight" states="draft"/>
                        <button name="wizard_approve" string="Approve" type="object"
                                groups="hr.group_hr_user" class="oe_highlight"
                                attrs="{'invisible': ['|', ('is_approver', '=', False), ('state', '!=', 'to_approve')]}"/>
                        <button name="action_rejected" string="Reject" type="object"
                                groups="hr.group_hr_user,account.group_account_invoice" class="oe_highlight"
                                attrs="{'invisible': ['|', ('is_approver', '=', False), ('state', '!=', 'to_approve')]}"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,applied,approved"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <label for="employee_id" class="oe_edit_only"/>
                            <h1>
                                <field name="employee_id" options="{'no_quick_create':True,'no_create_edit':True,'no_open': True,'no_create': True}" attrs="{'readonly':[('state','not in','draft')]}"/>
                            </h1>
                            <label for="name" class="oe_edit_only"/>
                            <h2>
                                <field name="name"/>
                            </h2>
                        </div>
                        <group>
                            <group>
                                <field name="loan_id" attrs="{'readonly':[('state','not in','draft')]}"/>
                                <field name="date_applied" force_save="1"/>
                                <field name="loan_type" widget="selection"
                                       on_change="onchange_loan_type(loan_type, employee_id)" force_save="1"/>

                            </group>
                            <group>
                                <field name="date_approved" force_save="1"/>
                                <field name="date_disb"
                                       groups="account.group_account_invoice" force_save="1"/>
                                <field name="department_id" force_save="1"/>
                                <field name="company_id" groups="base.group_multi_company"
                                       widget="selection" force_save="1"/>
                                <field name="user_id" force_save="1"/>
                                <field name="approvers_ids" widget="many2many_tags" invisible="1" force_save="1"/>
                                <field name="approved_user_ids" widget="many2many_tags" invisible="1" readonly="0" force_save="1"/>
                                <field name="is_approver" invisible="1" force_save="1"/>
                                <field name="approved_user_text" invisible="1" force_save="1"/>
                                <field name="approved_user" invisible="1" readonly="0" force_save="1"/>
                                <field name="job_id" invisible="1" force_save="1"/>
                                <field name="department_id" invisible="1" force_save="1"/>
                                <field name="feedback_parent" invisible="1" force_save="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="General">
                                <group>
                                    <field name="currency_id" groups="base.group_multi_currency" force_save="1"/>
                                    <field name="principal_amount" widget="monetary"
                                           options="{'currency_field': 'currency_id'}" force_save="1"/>
                                    <field name="int_payable" force_save="1"/>
                                    <field name="interest_mode" force_save="1"/>
                                    <field name="duration" force_save="1"/>
                                    <field name="employee_gross" groups="hr.group_hr_user,hr.group_hr_manager"
                                           required="False" invisible="1" force_save="1"/>
                                    <field name="int_rate" force_save="1"/>
                                    <field name="max_loan_amt" invisible="1"
                                           attrs="{'invisible':[('state','in',['draft','cancel'])]}" force_save="1"/>
                                </group>
                                <newline/>
                                <field name="installment_lines" readonly="1" nolabel="1">
                                    <tree editable="top" string="Installments">
                                        <field name="install_no" force_save="1"/>
                                        <field name="date_from" force_save="1"/>
                                        <field name="date_to" force_save="1"/>
                                        <field name="principal_amt" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" sum="Principal" force_save="1"/>
                                        <field name="interest_amt" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" sum="Interest" force_save="1"/>
                                        <field name="total" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" sum="Total" force_save="1"/>
                                        <field name="state" force_save="1"/>
                                        <field name="currency_id" groups="base.group_multi_currency" force_save="1"/>
                                        <field name="int_move_id" invisible="1" force_save="1"/>
                                        <button name="pay_installment"
                                                confirm="You are trying to create EMI for this loan so make sure loan repayment for this loan type is not from payroll !"
                                                states="approve" string="Pay" type="object"
                                                help="Pay Installment"/>
                                        <button name="book_interest"
                                                attrs="{'invisible':['|', ('interest_amt', '=', 0.0), ('int_move_id', '!=', False)]}"
                                                type="object"
                                                string="Book Interest"
                                                help="Book Interest"/>


                                        <button name="action_approve" states="unpaid" string="Approve Payment"
                                                type="object" help="Approve Payment"/>
                                        <button name="action_reset" states="approve" string="Reset To Draft"
                                                type="object" help="Reset To Draft"/>
                                    </tree>
                                </field>
                                <group>
                                    <group>
                                        <field name="final_total" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                        <field name="total_interest_amount" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                        <field name="total_amount_paid" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                        <field name="total_amount_due" colspan="2" widget="monetary"
                                               options="{'currency_field': 'currency_id'}" force_save="1"/>
                                    </group>
                                    <newline/>
                                </group>
                            </page>
                            <page string="Proofs">
                                <field name="loan_proof_ids" colspan="2" nolabel="1" force_save="1"/>
                            </page>
                            <page string="Accounting"
                                  groups="account.group_account_invoice">
                                <group>
                                    <field name="journal_id"
                                           colspan="2" force_save="1"/>
                                    <field name="move_id" colspan="2" force_save="1"/>
                                    <field name="journal_id1" force_save="1"/>
                                    <field name="journal_id2" force_save="1"/>
                                    <field name="employee_loan_account" colspan="2" force_save="1"/>
                                </group>
                            </page>
                            <page string="Policies"
                                  groups="hr.group_hr_user,account.group_account_invoice">
                                <separator string="Policies" colspan="4"/>
                                <field name="loan_policy_ids" nolabel="1" colspan="4" force_save="1"/>
                            </page>
                            <page string="Notes">
                                <field name="notes" colspan="2" nolabel="1" force_save="1"/>
                            </page>
                            <page string="Approval Matrix Lines">
                                <field name="loan_approver_user_ids">
                                    <tree editable="bottom" create="false" delete="false">
                                        <field name="name" force_save="1"/>
                                        <field name="user_ids" widget="many2many_tags" readonly="1" force_save="1"/>
                                        <field name="matrix_user_ids" widget="many2many_tags" invisible="1" readonly="1" force_save="1"/>
                                        <field name="is_delegation_mail_sent" invisible="1"/>
                                        <field name="minimum_approver" readonly="1" force_save="1"/>
                                        <field name="timestamp" invisible="1" force_save="1"/>
                                        <field name="approver_state" invisible="1" force_save="1"/>
                                        <field name="approval_status" readonly="1" force_save="1"/>
                                        <field name="approved_time" readonly="1" force_save="1"/>
                                        <field name="is_approve" invisible="1" force_save="1"/>
                                        <field name="approved_employee_ids" invisible="1"/>
                                        <field name="feedback" readonly="1" force_save="1"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"
                               groups="base.group_user"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
        <!-- <record id="action_loan_cancelation" model="ir.actions.act_window">
            <field name="name">Loan Cancellation</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">employee.loan.cancelation</field>
            <field name="view_mode">tree,form</field>
            <field name="view_ids" eval="[(5, 0, 0),
    (0, 0, {'view_mode': 'tree', 'view_id': ref('equip3_hr_employee_loan_extend.view_loan_cancel_tree')}),
    (0, 0, {'view_mode': 'form', 'view_id': ref('equip3_hr_employee_loan_extend.view_loan_cancel_form')})]"/>
            <field name="help">Create New Loan Cancellation
            </field>
        </record> -->

        <record id="view_employee_loan_cancelation_filter" model="ir.ui.view">
            <field name="name">employee.loan.cancelation.filter</field>
            <field name="model">employee.loan.cancelation</field>
            <field name="arch" type="xml">
                <search string="Search cancelation">
                    <field name="employee_id"/>
                    <filter string="Pending My Approval" name="pending_my_approval" domain="[('approvers_ids', 'in', uid),('approved_user_ids','not in',uid)]"/>
                </search>
            </field>
        </record>

        <record id="action_loan_cancelation" model="ir.actions.server">
            <field name="name">Loan Cancellation</field>
            <field name="type">ir.actions.server</field>
            <field name="state">code</field>
            <field name="model_id" ref="equip3_hr_employee_loan_extend.model_employee_loan_cancelation"/>
            <field name="code">action = model.custom_menu()</field>
        </record>



        <record id="action_loan_cancelation_manager" model="ir.actions.act_window">
            <field name="name">Loan Cancellation To Approve</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">employee.loan.cancelation</field>
            <field name="view_mode">tree,form</field>
            <field name="view_ids" eval="[(5, 0, 0),
    (0, 0, {'view_mode': 'tree', 'view_id': ref('equip3_hr_employee_loan_extend.view_loan_cancel_tree_manager')}),
    (0, 0, {'view_mode': 'form', 'view_id': ref('equip3_hr_employee_loan_extend.view_loan_cancel_form_manager')})]"/>
            <field name="domain">[('state', '=', 'to_approve')]</field>
            <field name="context">{'search_default_pending_my_approval': 1}</field>
            <field name="help">Create New Loan Cancellation
            </field>
        </record>
        <menuitem action="action_loan_cancelation" id="loan_cancel"
                  parent="hr_employee_loan.loan_loans" name="Loan Cancelation"/>
        <menuitem action="action_loan_cancelation_manager" id="loan_cancel_manager"
                  parent="hr_employee_loan.loan_loans" 
                  groups="equip3_hr_employee_loan_extend.group_loan_supervisor"
                  name="Loan Cancelation To Approve"/>
    </data>
</odoo>