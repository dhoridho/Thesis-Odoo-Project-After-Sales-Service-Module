<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>

        <!-- REUSED WORKORDER TREE VIEW FOR MANUFACTURING ORDER & MANUFACTURING PLAN -->
        <!-- SEE BELOW FOR WORKORDER ON MANUFACTURING PLAN ONLY -->
        <record id="mrp_workorder_tree_editable_view_inherit" model="ir.ui.view">
            <field name="name">mrp_workorder_tree_editable</field>
            <field name="model">mrp.workorder</field>
            <field name="inherit_id" ref="mrp.mrp_production_workorder_tree_editable_view"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='name'][2]" position="attributes">
                    <attribute name="attrs">{'readonly': [('production_state', '!=', 'draft')]}</attribute>
                </xpath>

                <xpath expr="//field[@name='date_planned_start']" position="attributes">
                    <attribute name="attrs">{'readonly': [('production_state', '!=', 'draft')]}</attribute>
                </xpath>
                <xpath expr="//field[@name='date_planned_finished']" position="attributes">
                    <attribute name="attrs">{'readonly': [('production_state', '!=', 'draft')]}</attribute>
                </xpath>

                <xpath expr="//field[@name='name']" position="before">
                    <field name="mrp_plan_id" invisible="1"/>
                    <field name="workorder_id" string="Production Work Order" readonly="1"/>
                </xpath>

                <xpath expr="//field[@name='state']" position="attributes">
                    <attribute name="decoration-info">False</attribute>
                    <attribute name="decoration-muted">state == 'pending'</attribute>
                    <attribute name="decoration-primary">state == 'ready'</attribute>
                    <attribute name="decoration-warning">state == 'progress'</attribute>
                    <attribute name="decoration-primary2">state == 'pause'</attribute>
                    <attribute name="decoration-danger">state == 'block'</attribute>
                    <attribute name="decoration-success">state == 'done'</attribute>
                    <attribute name="decoration-danger3">state == 'cancel'</attribute>
                    <attribute name="attrs">{}</attribute>
                </xpath>
                <xpath expr="//field[@name='state']" position="after">
                    <field name="previous_state" invisible="1"/>
                </xpath>
                <xpath expr="field[@name='workcenter_id']" position="after">
                    <field name="location_id" options="{'no_create': True, 'no_create_edit':True}" attrs="{'readonly': [('production_state', '!=', 'draft')]}"/>
                    <field name="workcenter_ids" widget='many2many_tags' invisible="1"/>
                    <field name="allowed_workcenter_ids" widget='many2many_tags' invisible="1"/>
                    <field name="tool_ids" invisible="1"/>
                </xpath>
                <xpath expr="field[@name='workcenter_id']" position="attributes">
                    <attribute name="options">{'no_create': True}</attribute>
                    <attribute name="domain">[('id', 'in', allowed_workcenter_ids)]</attribute>
                    <attribute name="attrs">{'readonly': [('state', 'in', ['progress', 'done'])]}</attribute>
                </xpath>

                <xpath expr="//field[@name='duration_expected']" position="attributes">
                    <attribute name="widget">float_time_hms</attribute>
                    <attribute name="attrs">{'readonly': [('production_state', '!=', 'draft')]}</attribute>
                </xpath>

                <xpath expr="//field[@name='duration']" position="attributes">
                    <attribute name="attrs">{'invisible': [('production_state','=', 'draft')], 'readonly': [(1, '=', 1)]}</attribute>
                    <attribute name="force_save">1</attribute>
                    <attribute name="widget">equip_time_counter</attribute>
                </xpath>

                <xpath expr="//field[@name='date_start']" position="attributes">
                    <attribute name="string">Actual Start Date</attribute>
                </xpath>

                <xpath expr="//field[@name='date_finished']" position="attributes">
                    <attribute name="string">Actual End Date</attribute>
                </xpath>

                <!-- change button visibility for added state: approval, approved, & reject -->
                <xpath expr="//button[@name='button_start']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', '|', '|', ('production_state','in', ('draft', 'done', 'approval', 'approved', 'reject')), ('working_state', '=', 'blocked'), ('state', '=', 'done'), ('is_user_working', '!=', False)]}</attribute>
                    <attribute name="style">padding: 5px;</attribute>
                </xpath>
                <xpath expr="//button[@name='button_pending']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', '|', ('production_state', 'in', ('draft', 'done', 'approval', 'approved', 'reject')), ('working_state', '=', 'blocked'), ('is_user_working', '=', False)]}</attribute>
                    <attribute name="style">padding: 5px;</attribute>
                </xpath>
                <xpath expr="//button[@name='button_finish']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', '|', ('production_state', 'in', ('draft', 'done', 'approval', 'approved', 'reject')), ('working_state', '=', 'blocked'), ('is_user_working', '=', False)]}</attribute>
                    <attribute name="style">padding: 5px;</attribute>
                </xpath>
                <xpath expr="//button[@name='%(mrp.act_mrp_block_workcenter_wo)d']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', ('production_state','in', ('draft', 'done', 'approval', 'approved', 'reject')), ('working_state', '=', 'blocked')]}</attribute>
                    <attribute name="style">padding: 5px;</attribute>
                </xpath>
                <xpath expr="//button[@name='button_unblock']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', ('production_state', 'in', ('draft', 'done', 'approval', 'approved', 'reject')), ('working_state', '!=', 'blocked')]}</attribute>
                    <attribute name="style">padding: 5px;</attribute>
                </xpath>
            </field>
        </record>

        <!-- WORKORDER TREE VIEW FOR MANUFACTURING PLAN ONLY -->
        <record id="mrp_workorder_tree_editable_view_plan" model="ir.ui.view">
            <field name="name">mrp_workorder_tree_editable_plan</field>
            <field name="model">mrp.workorder</field>
            <field name="inherit_id" ref="equip3_manuf_operations.mrp_workorder_tree_editable_view_inherit"/>
            <field name="mode">primary</field>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='workorder_id']" position="before">
                    <field name="mrp_plan_id" invisible="1"/>
                    <field name="production_id" string="PRODUCTION ORDER"/>
                </xpath>
                <xpath expr="//tree" position="attributes">
                    <attribute name="create">false</attribute>
                </xpath>
            </field>
        </record>

        <!-- mrp production work order tree view inherit -->
        <record id="mrp_production_workorder_tree_view_inherit" model="ir.ui.view">
            <field name="name">mrp.production.workorder.tree.view.inherit</field>
            <field name="model">mrp.workorder</field>
            <field name="inherit_id" ref="mrp.mrp_production_workorder_tree_view"/>
            <field name="arch" type="xml">
                <xpath expr="//button[@name='%(mrp.act_mrp_block_workcenter_wo)d']" position="attributes">
                    <attribute name="attrs">{'invisible': [('state', 'not in', ('ready', 'progress', 'pause'))]}</attribute>
                </xpath>
                <xpath expr="//button[@name='button_unblock']" position="attributes">
                    <attribute name="attrs">{'invisible': [('state', '!=', 'block')]}</attribute>
                </xpath>
                <xpath expr="//button[@name='action_open_wizard']" position="attributes">
                    <attribute name="icon">o-hm2-external_link</attribute>
                    <attribute name="style">font-size: 22px;</attribute>
                </xpath>
                <xpath expr="//field[@name='workcenter_id']" position="before">
                    <field name="workcenter_domain" invisible="1"/>
                </xpath>
                <xpath expr="//field[@name='workcenter_id']" position="attributes">
                    <attribute name="domain">workcenter_domain</attribute>
                </xpath>
            </field>
        </record>

        <record id="equip3_mrp_production_workorder_form_view_inherit" model="ir.ui.view">
            <field name="name">equip3_mrp_workorder_tree_editable</field>
            <field name="model">mrp.workorder</field>
            <field name="inherit_id" ref="mrp.mrp_production_workorder_form_view_inherit"/>
            <field name="arch" type="xml">
                <xpath expr="//group" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//group" position="before">
                    <group name="group_work_order">
                        <div name="container_work_order">
                            <div class="row" name="row_work_order">
                                <div class="col" name="col_1">
                                    <group name="group_col_1">
                                        <group>
                                            <field name="product_id"/>
                                            <label for="qty_production" string="Quantity"/>
                                            <div class="o_row no-gutters d-flex">
                                                <div class="o_row">
                                                    <field name="qty_produced" class="text-left"/> /
                                                </div>
                                                <field name="qty_production" class="oe_inline text-left"/>
                                                <label for="product_uom_id" string="" class="oe_inline"/>
                                                <field name="product_uom_id" options="{'no_open': True, 'no_create': True}" force_save="1" groups="uom.group_uom"/>
                                                <span class="text-bf">Produced</span>
                                            </div>
                                            <field name="workcenter_id" readonly="1"/>
                                            <field name="location_id" string="Work Center Location" readonly="1"/>
                                            <field name="mrp_plan_id" attrs="{'invisible' : [('mrp_plan_id', '=', False)]}"/>
                                            <field name="production_id" string="Production Order" readonly="1"/>
                                        </group>
                                    </group>
                                </div>
                                <div class="col" name="col_2">
                                    <group name="group_col_2" attrs="{'invisible': [('date_planned_start', '=', False)]}">
                                        <label for="date_planned_start" string="Planned Date"/>
                                        <div class="oe_inline">
                                            <field name="date_planned_start" class="mr8 oe_inline" required="True"/>
                                            <strong class="mr8 oe_inline">to</strong>
                                            <field name="date_planned_finished" class="oe_inline" required="True"/>
                                            <field name="show_json_popover" invisible="1"/>
                                            <field name="json_popover" widget="mrp_workorder_popover" class="oe_inline mx-2" attrs="{'invisible': [('show_json_popover', '=', False)]}"/>
                                        </div>
                                        <label for="duration_expected"/>
                                        <div class="o_row">
                                            <field name="duration_expected" widget="float_time"/>
                                            <span>minutes</span>
                                        </div>
                                    </group>
                                </div>
                                <div class="col" name="col_3">
                                    <group name="group_col_3">
                                        <field name="company_id" readonly="1"/>
                                        <field name="branch_id"/>
                                        <field name="create_date" string="Created On" readonly="1"/>
                                        <field name="create_uid" string="Created By" readonly="1"/>
                                        <field name="bom_finished_type" invisible="1"/>
                                    </group>
                                </div>
                            </div>
                        </div>
                    </group>
                </xpath>

                <xpath expr="//div[@name='button_box']" position="after">
                    <div class="oe_title">
                        <h1><field name="workorder_id" string="Production Work Order" readonly="1"/></h1>
                    </div>
                </xpath>
                
                <!-- FORM GRID -->
                <xpath expr="//label[@for='date_planned_start']" position="attributes">
                    <attribute name="string">Scheduled Date</attribute>
                </xpath>

                <xpath expr="//label[@for='duration_expected']" position="before">
                    <label for="actual_start_date" string="Actual Date"/>
                    <div class="oe_row" attrs="{'invisible': [('actual_start_date', '=', False)]}">
                        <field name="actual_start_date" class="mr8 oe_inline" options="{'widget': 'datetime', 'format': 'short'}"/>
                        <strong class="mr8 oe_inline">to</strong>
                        <field name="actual_end_date" class="mr8 oe_inline" options="{'widget': 'datetime', 'format': 'short'}"/>
                   </div>
                </xpath>

                <xpath expr="//field[@name='duration_expected']" position="attributes">
                    <attribute name="readonly">1</attribute>
                    <attribute name="widget">float_time_hms</attribute>
                </xpath>

                <xpath expr="//field[@name='duration_expected']/parent::div/span" position="replace">
                    <span>hours</span>
                </xpath>

                <xpath expr="//group/div/div/div[@name='col_2']/group" position="inside">
                    <label for="duration"/>
                    <div class="o_row">
                        <field name="duration" widget="equip_time_counter"/>
                        <span>hours</span>
                    </div>
                </xpath>

                <!-- TABS -->
                <xpath expr="//page[@name='time_tracking']" position="before">
                    <page string="Finished Goods" name="finished_goods" attrs="{'invisible': [('bom_finished_type', '!=', 'multi')]}">
                        <field name="move_finished_only_ids" context="{'force_readonly': 1}">
                            <tree string="Finished Goods">
                                <field name="product_tmpl_id" string="Product"/>
                                <field name="product_id" string="Variant"/>
                                <field name="product_uom_qty" string="Quantity"/>
                                <field name="product_uom" string="Unit of Measure"/>
                                <field name="state" invisible="1"/>
                            </tree>
                        </field>
                    </page>

                    <page string="Materials" name="components">
                        <field name="move_raw_ids" readonly="1" force_save="1">
                            <tree editable="bottom" create="false">
                                <field name="product_id" required="1" readonly="1"/>
                                <field name="product_uom_qty" string="To Consume"/>
                                <field name="forecast_availability" string="Reserved"/>
                                <field name="quantity_done" string="Consumed"/>
                                <field name="product_uom" groups="uom.group_uom"/>
                                <field name="lot_ids" widget="many2many_tags" domain="[('product_id', '=', product_id)]" readonly="1"/>
                                <field name="company_id" invisible="1"/>
                                <field name="product_uom_category_id" invisible="1"/>
                                <field name="state" force_save="1" widget="badge" decoration-success="state == 'done'" decoration-info="state not in ('done', 'cancel')"/>
                            </tree>
                        </field>
                    </page>
                    <page string="By-Product" name="byproduct" attrs="{'invisible': [('byproduct_ids', '=', [])]}">
                        <field name="byproduct_ids" readonly="1">
                            <tree editable="bottom">
                                <field name="product_id" required="1" readonly="1"/>
                                <field name="product_uom_qty" string="To Produce" readonly="1"/>
                                <field name="product_uom" groups="uom.group_uom" readonly="1"/>
                                <field name="company_id" invisible="1"/>
                                <field name="product_uom_category_id" invisible="1"/>
                                <field name="state" force_save="1" widget="badge" decoration-success="state == 'done'" decoration-info="state not in ('done', 'cancel')"/>
                            </tree>
                        </field>
                    </page>
                    <page name="tools" string="Tools" attrs="{'invisible': [('tool_ids', '=', [])]}">
                        <field name="tool_ids" readonly="1">
                            <tree string="Tools">
                                <field name="company_id" invisible="1"/>
                                <field name="product_id"/>
                                <field name="quantity"/>
                                <field name="uom_id"/>
                            </tree>
                        </field>
                    </page>
                </xpath>

                <xpath expr="//page[@name='time_tracking']" position="inside">
                    <group string="Assigned Labor">
                        <field name="assign_ids" nolabel="1" readonly="1">
                            <tree>
                                <field name="plan_id" invisible="1"/>
                                <field name="production_id" string="PRODUCTION ORDER" invisible="1"/>
                                <field name="allowed_workorder_ids" invisible="1"/>
                                <field name="workorder_id" invisible="1"/>
                                <field name="workorder_state" invisible="1"/>
                                <field name="labor_id"/>
                            </tree>
                        </field>
                    </group>
                </xpath>
            </field>
        </record>

        <record id="view_mrp_production_workorder_form_view_filter_inherited" model="ir.ui.view">
            <field name="name">mrp.production.work.order.select.inherited</field>
            <field name="model">mrp.workorder</field>
            <field name="inherit_id" ref="mrp.view_mrp_production_workorder_form_view_filter"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='production_id']" string="PRODUCTION ORDER" position="before">
                    <field name="mrp_plan_id"/>
                </xpath>

                <xpath expr="//field[@name='production_id']" string="PRODUCTION ORDER" position="after">
                    <xpath expr="//field[@name='name']" position="move"/>
                    <xpath expr="//field[@name='workcenter_id']" position="move"/>
                </xpath>

                <xpath expr="//filter[@name='finish']" position="after">
                    <filter name="cancel" string="Cancelled" domain="[('state', '=', 'cancel')]"/>
                </xpath>

                <xpath expr="//field[last()]" position="after">
                    <field name="product_id" string="Finished Goods"/>
                    <field name="move_raw_ids" string="Material" filter_domain="[('move_raw_ids.product_id', 'ilike', self)]"/>
                </xpath>

                <xpath expr="//filter[last()]" position="after">
                    <separator/>
                    <filter string="Waiting for Material" name="waiting" domain="[('production_availability', 'in', ('waiting', 'confirmed'))]"/>
                    <filter string="Material Available" name="filter_ready" domain="[('production_availability', '=', 'assigned')]"/>
                    <filter name="filter_date_planned_start" string="Scheduled Date" date="date_planned_start"/>
                </xpath>

                <xpath expr="//filter[@name='work_center']" position="before">
                    <filter string="Production Plan" name="mrp_plan_id" domain="[]" context="{'group_by': 'mrp_plan_id'}"/>
                    <xpath expr="//filter[@name='production']" position="move"/>
                </xpath>

                <xpath expr="//group" position="inside">
                    <filter string="Material Availability" name="groupby_production_availability" domain="[]" context="{'group_by': 'production_availability'}"/>
                </xpath>

                <xpath expr="//field[@name='production_id']" position="attributes">
                    <attribute name="string">Production Work Order</attribute>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
