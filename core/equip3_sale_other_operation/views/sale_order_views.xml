<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--Add parent-->
    <record model="ir.ui.menu" id="equip3_sale_other_operation.menu_limit_request">
        <field name='name'>Customers Limit Request</field>
        <field name="parent_id" ref="equip3_sale_masterdata.customer_menu"/>
        <field name="sequence">6</field>
    </record>

    <record model="ir.actions.act_window" id="equip3_sale_other_operation.action_credit_limit_request">
        <field name='name'>Customers Limit Request</field>
    </record>

    <record id="inherit_sh_sale_order_credit_limit_form_inherit" model="ir.ui.view">
        <field name="name">sale.orer.form.view.inherit.sh.sale.order.credit.limit.form.inherit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sh_sale_credit_limit.sh_sale_order_credit_limit_form_inherit"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id="sale_order_form_view_inherit_sale_operation" model="ir.ui.view">
        <field name="name">sale.orer.form.view.inherit.from.sale.operation</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="equip3_sale_operation.sale_order_form_view_inherit_sale_operation"/>
        <field name="arch" type="xml">
            <field name="is_customer_approval_matrix">
                <field name="is_over_limit_validation" invisible="1"/>
            </field>
            <xpath expr="//button[@name='action_quotation_send'][4]" position="attributes">
                <attribute name="attrs">{'invisible': ['|', '|', '|', '&amp;', ('is_customer_approval_matrix', '=', False), ('is_over_limit_validation', '=', False), ('state', '!=', 'draft'), ('hide_proforma', '=', True), ('invoice_count','&gt;=',1)]}</attribute>
            </xpath>
        </field>
    </record>

    <record id="inherit_sale_order_form_view_from_sale_operation" model="ir.ui.view">
            <field name="name">sale.orer.form.view.inherit.from.sale.operation</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="equip3_sale_operation.inherit_sale_order_form_view"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='approval_matrix_line_id']" position="after">
                    <field name="is_limit_matrix_filled" invisible="1"/>
                    <field name="is_direct_confirm" invisible="1"/>
                    <field name="is_over_limit_validation" invisible="1"/>
                    <field name="creditlim" invisible="1"/>
                    <field name="limit_approval_matrix_line_id" invisible="1"/>
                    <field name="is_limit_matrix_filled" invisible="1"/>
                    <field name="is_approve_button_limit" invisible="1"/>
                </xpath>
                <xpath expr="//notebook/page[@name='sale_order_approval_matrix_line']" position="before">
                    <page name="over_limit_approval_matrix_line" string="Over Limit Approval Matrix Line" attrs="{'invisible': [('is_limit_matrix_filled', '=', False)]}">
                        <group>
                            <field name="approving_matrix_limit_id" widget="many2many_tags" force_save="1" readonly="1" attrs="{'invisible': [('is_limit_matrix_filled', '=', False)]}"/>
                        </group>
                        <field name="approved_matrix_limit_ids" context="{'approved_matrix_limit_ids': approved_matrix_limit_ids}">
                            <tree editable="bottom">
                                <field name="sequence" />
                                <field name="user_name_ids" widget="many2many_tags"/>
                                <field name="approval_type"/>
                                <field name="minimum_approver" />
                                <field name="state_char" />
                                <field name="approver_state"/>
                                <field name="time_stamp" />
                                <field name="feedback" />
                            </tree>
                        </field>
                    </page>
                </xpath>
                <xpath expr="//button[@name='action_cancel']" position="attributes">
                    <attribute name="states">draft,sent,waiting_for_approval,waiting_for_over_limit_approval,quotation_approved,over_limit_approved,sale</attribute>
                </xpath>
                <xpath expr="//button[@name='action_confirm_approving']" position="after">
<!--                    <button name="action_confirm_approving_credit_limit" type="object" string="Request Credit Limit" class="oe_highlight oe_read_only" attrs="{'invisible': ['|',('is_over_limit', '=', True),('is_credit_limit', '=', False)]}"/>-->
                    <button name="action_confirm_approving_over_limit" type="object" string="Request Over Limit" class="oe_highlight oe_read_only" attrs="{'invisible': ['|',('is_over_limit', '=', False),('state','!=','draft')]}"/>
                </xpath>
                <xpath expr="//button[@name='action_confirm_approving']" position="attributes">
<!--                    <attribute name="attrs">{'invisible': ['|', '|', '|', ('is_credit_limit', '=', True), ('is_customer_approval_matrix', '=', False), ('state', 'not in', ('draft','over_limit_approved')), ('is_approval_matrix_filled', '!=', False)]}</attribute>-->
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//button[@name='action_request_for_approving']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', '|', ('is_over_limit','=',True),('is_customer_approval_matrix', '=', False),('state', 'not in', ('draft','over_limit_approved'))]}</attribute>
                </xpath>
                <xpath expr="//header[1]" position="inside">
                    <field name="is_credit_limit" invisible="1"/>
                    <field name="is_over_limit" invisible="1"/>
                    <field name="limit_matrix_state" widget="statusbar" statusbar_visible="draft,waiting_for_over_limit_approval,sent,sale" 
                        attrs="{'invisible': ['|', '|', ('is_over_limit_validation', '=', False), ('is_customer_approval_matrix', '=', True), ('state', '!=', 'waiting_for_over_limit_approval')]}"/>
                    
                    <field name="limit_matrix_state_2" widget="statusbar" statusbar_visible="draft,over_limit_approved,sent,sale" 
                        attrs="{'invisible': ['|', '|', '|', 
                        ('is_direct_confirm', '=', True),
                        ('is_over_limit_validation', '=', False), ('is_customer_approval_matrix', '=', True), ('state', 'not in', ('over_limit_approved', 'sale'))]}"/>
                    <field name="limit_matrix_state_1" widget="statusbar" statusbar_visible="draft,over_limit_reject" attrs="{'invisible': [('state', '!=', 'over_limit_reject')]}"/>

                    <field name="sale_limit_state" widget="statusbar" statusbar_visible="draft,waiting_for_over_limit_approval,waiting_for_approval,sale" attrs="{'invisible': ['|', '|', '|', ('state', '!=', 'waiting_for_over_limit_approval'), ('is_customer_approval_matrix', '=', False), ('is_over_limit_validation', '=', False), ('is_approval_matrix_filled', '=', False)]}"/>

                    <field name="sale_limit_state_1" widget="statusbar" statusbar_visible="draft,over_limit_approved,waiting_for_approval,sale" attrs="{'invisible': ['|', '|', '|', '|', ('is_direct_confirm', '=', True), ('state', 'not in', ('over_limit_approved', 'waiting_for_approval')), ('is_customer_approval_matrix', '=', False), ('is_over_limit_validation', '=', False),('is_approval_matrix_filled', '=', False)]}"/>

                    <field name="sale_limit_state_2" widget="statusbar" statusbar_visible="draft,waiting_for_over_limit_approval,quotation_approved,sale" attrs="{'invisible': ['|', '|', '|', ('state', '!=', 'waiting_for_over_limit_approval'), ('is_customer_approval_matrix', '=', False), ('is_over_limit_validation', '=', False), ('is_approval_matrix_filled', '=', True)]}"/>

                    <field name="sale_limit_state_3" widget="statusbar" statusbar_visible="draft,over_limit_approved,quotation_approved,sale" attrs="{'invisible': ['|', '|', '|', '|', ('is_direct_confirm', '=', True), ('state', 'not in', ('over_limit_approved', 'quotation_approved', 'waiting_for_approval', 'sale', 'done')), ('is_customer_approval_matrix', '=', False), ('is_over_limit_validation', '=', False),('is_approval_matrix_filled', '=', True)]}"/>

                    <field name="approval_matrix_state_7" widget="statusbar" statusbar_visible="draft,quotation_approved,sale" attrs="{'invisible': ['|', '|', '|', '|', ('is_direct_confirm', '=', False), ('state', 'not in', ('over_limit_approved', 'quotation_approved', 'waiting_for_approval', 'sale', 'done')), ('is_customer_approval_matrix', '=', False), ('is_over_limit_validation', '=', False),('is_approval_matrix_filled', '=', True)]}"/>

                    <field name="sale_limit_state_4" widget="statusbar" statusbar_visible="draft,sent,sale" attrs="{'invisible': ['|', '|', ('is_customer_approval_matrix', '=', True), 
                    ('state', 'in', ('waiting_for_over_limit_approval', 'waiting_for_approval', 'revised', 'reject', 'over_limit_reject', 'over_limit_approved',  'cancel','sale')),
                    ('is_over_limit_validation', '=', False)]}"/>
                </xpath>

                <!--"make the button in the header invisible when creating a Sales Order, but only if not saving"-->
                <xpath expr="//header" position="attributes">
                    <attribute name="attrs">{'invisible': [('id', '=', False)]}</attribute>
                </xpath>
                <xpath expr="//header[1]" position="after">
                    <header attrs="{'invisible':['|',('id', '!=', False), ('is_customer_approval_matrix', '=', True)]}">
                        <field name="state" widget="statusbar" statusbar_visible="draft,sent,sale"/>
                    </header>
                    <header attrs="{'invisible':['|',('id', '!=', False), ('is_customer_approval_matrix', '=', False)]}">
                        <field name="approval_matrix_state" widget="statusbar" statusbar_visible="draft,quotation_approved,sale"/>
                    </header>

                </xpath>

                <xpath expr="//button[@name='action_quotation_send']" position="before">
<!--                     <button name="action_request_for_approving_limit" type="object" string="Confirm" class="oe_highlight" attrs="{'invisible': ['|', '|', ('is_customer_approval_matrix', '=', True), ('is_over_limit_validation', '=', False), ('state', 'not in', ('draft', 'sent'))]}"/>-->

                     <button name="action_confirm_approving_limit_matrix" type="object" string="Approve Over Limit" class="oe_highlight" attrs="{'invisible': ['|', '|', '|', '|', ('is_over_limit', '=', False), ('is_over_limit_validation', '=', False), ('state', '!=', 'waiting_for_over_limit_approval'), ('is_limit_matrix_filled', '=', False), ('is_approve_button_limit', '=', False)]}"/>

                     <button name="action_reject_limit_approving_matrix" type="object" string="Reject Over Limit" attrs="{'invisible': ['|', '|', '|', '|', ('is_over_limit', '=', False), ('is_over_limit_validation', '=', False), ('state', '!=', 'waiting_for_over_limit_approval'), ('is_limit_matrix_filled', '=', False), ('is_approve_button_limit', '=', False)]}"/>

<!--                    <button name="action_confirm_approving_limit_matrix" type="object" string="Approve Credit Limit" class="oe_highlight" attrs="{'invisible': ['|', '|', '|', '|', ('is_over_limit', '=', True), ('is_over_limit_validation', '=', False), ('state', '!=', 'waiting_for_over_limit_approval'), ('is_limit_matrix_filled', '=', False), ('is_approve_button_limit', '=', False)]}"/>-->

<!--                    <button name="action_reject_limit_approving_matrix" type="object" string="Reject Credit Limit" attrs="{'invisible': ['|', '|', '|', '|', ('is_over_limit', '=', True), ('is_over_limit_validation', '=', False), ('state', '!=', 'waiting_for_over_limit_approval'), ('is_limit_matrix_filled', '=', False), ('is_approve_button_limit', '=', False)]}"/>-->
                </xpath>

                <xpath expr="//button[@name='action_quotation_send']" position="attributes">
                    <attribute name="states">draft,quotation_approved</attribute>
                    <attribute name="attrs">{'invisible': ['|', '&amp;', '|', ('is_customer_approval_matrix', '=', True), ('is_over_limit_validation', '=', True), ('state', '!=', 'quotation_approved')]}</attribute>
                </xpath>

                <xpath expr="//button[@id='action_confirm']" position="attributes">
                    <attribute name="class">oe_highlight oe_read_only</attribute>
                    <attribute name="attrs">{'invisible': [('show_action_confirm','=',False)]}</attribute>
                </xpath>

                <xpath expr="//button[@id='action_confirm'][1]" position="attributes">
                    <attribute name="class">oe_highlight oe_read_only</attribute>
                    <attribute name="attrs">{'invisible': [('show_action_confirm','=',False)]}</attribute>
                </xpath>

                <button name="action_quotation_send" position="after">
                    <button name="action_request_for_approval_limit" type="object" string="Request For Approval" states="over_limit_approved" class="oe_highlight" attrs="{'invisible': ['|', '|', ('is_customer_approval_matrix', '=', False), ('is_approval_matrix_filled', '=', False)]}"/>
                    <button name="action_request_for_approval_limit" type="object" string="Approve" states="over_limit_approved" class="oe_highlight" attrs="{'invisible': ['|', '|', ('is_customer_approval_matrix', '=', False), ('is_approval_matrix_filled', '=', True)]}"/>
                </button>

                <field name="state" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', '|', ('state', '=', 'cancel'), ('is_customer_approval_matrix', '=', True), ('is_over_limit_validation', '=', True)]}</attribute>
                    <attribute name="invisible">0</attribute>
                    <attribute name="statusbar_visible">draft,sent,sale</attribute>
                </field>

                <field name="approval_matrix_state" position="attributes">
                    <attribute name="attrs">
                        {'invisible': ['|', '|', 
                        ('is_customer_approval_matrix', '=', False),
                        ('is_over_limit_validation', '=', True),
                        ('state', 'in', ('reject', 'cancel', 'revised'))]}
                    </attribute>
                </field>

                <field name="approval_matrix_state" position="after">
                    <field name="show_action_confirm" invisible="1"/>
                    <field name="approval_matrix_state_2" widget="statusbar" statusbar_visible="draft,sent,sale" 
                        attrs="{'invisible': ['|', '|', '|', 
                        ('is_direct_confirm', '=', False),
                        ('is_over_limit_validation', '=', False), ('is_customer_approval_matrix', '=', True), ('state', 'not in', ('over_limit_approved', 'sale', 'done'))]}"/>
                    
                    <field name="approval_matrix_state_3" widget="statusbar" statusbar_visible="draft,waiting_for_approval,sale" attrs="{'invisible': ['|', '|', '|', '|', ('is_direct_confirm', '=', False), ('state', 'not in', ('over_limit_approved', 'waiting_for_approval')), ('is_customer_approval_matrix', '=', False), ('is_over_limit_validation', '=', False),('is_approval_matrix_filled', '=', False)]}"/>

                    <field name="approval_matrix_state_4" widget="statusbar" statusbar_visible="draft,quotation_approved,sale" attrs="{'invisible': ['|', '|', ('is_over_limit_validation', '=', False), 
                    ('is_customer_approval_matrix', '=', False),
                    ('state', '!=', 'draft'),
                    ]}"/>
                    <field name="approval_matrix_state_5" widget="statusbar" statusbar_visible="draft,over_limit_approved,quotation_approved,sale" attrs="{'invisible': ['|', '|', '|', '|', '|', 
                    ('is_direct_confirm', '=', True), ('is_over_limit_validation', '=', False), 
                    ('is_customer_approval_matrix', '=', False),
                    ('state', 'not in', ('quotation_approved', 'sale', 'done')),
                    ('is_approval_matrix_filled', '=', False),
                    '&amp;', ('is_limit_matrix_filled', '=', False),
                    ('is_approval_matrix_filled', '=', False)
                    ]}"/>
                    <field name="approval_matrix_state_8" widget="statusbar" statusbar_visible="draft,over_limit_approved,quotation_approved,sent,sale" attrs="{'invisible': ['|', '|', '|',
                    ('is_over_limit_validation', '=', False), 
                    ('creditlim', '=', False), 
                    ('is_customer_approval_matrix', '=', False),
                    ('state', '!=', 'sent'),
                    '&amp;', ('is_limit_matrix_filled', '=', False),
                    ]}"/>
                    <field name="approval_matrix_state_9" widget="statusbar" statusbar_visible="draft,quotation_approved,sent,sale" attrs="{'invisible': ['|', '|', '|',
                    ('is_over_limit_validation', '=', False), 
                    ('creditlim', '=', True),
                    ('is_customer_approval_matrix', '=', False),
                    ('state', '!=', 'sent'),
                    '&amp;', ('is_limit_matrix_filled', '=', False),
                    ]}"/>
                    <field name="approval_matrix_state_6" widget="statusbar" statusbar_visible="draft,quotation_approved,sale" attrs="{'invisible': ['|', '|', '|', '|', '|', 
                    ('is_direct_confirm', '=', False),
                    ('is_over_limit_validation', '=', False), 
                    ('is_customer_approval_matrix', '=', False),
                    ('state', 'not in', ('quotation_approved', 'sale', 'done')),
                    ('is_approval_matrix_filled', '=', False),
                    '&amp;', ('is_limit_matrix_filled', '=', False),
                    ('is_approval_matrix_filled', '=', False)
                    ]}"/>
                </field>
            </field>
    </record>
    

        <record id="sale_order_form_view_inherit_sale_other_operation" model="ir.ui.view">
            <field name="name">sale.orer.form.view.inherit.other.operation</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_id']" position="after">
                    <field name="show_customer_product_label" invisible="1"/>
                </xpath>
                <xpath expr="//button[@name='action_draft']" position="attributes">
                    <attribute name="attrs">{'invisible': [('state', 'not in', ['over_limit_reject', 'cancel'])]}</attribute>
                </xpath>
                <xpath expr="//field[@name='order_line']/tree/field[@name='name']" position="after">
                    <field name="product_label" string="Customer Label" attrs="{'column_invisible':[('parent.show_customer_product_label', '=', False)]}" readonly="1" force_save="1"/>
                </xpath>
            </field>
        </record>

    <record id="sale_order_inherited_view_quotation_revision" model="ir.ui.view">
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="quotation_revision.sale_order_inherited_view_quotation_revision"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet/group/group/field[@name='partner_id']" position="before">
                <field name="hide_button_revise" invisible="1"/>
            </xpath>
            <xpath expr="//button[@name='so_revision_quote']" position="attributes">
                <attribute name="attrs">{'invisible': [('hide_button_revise', '=', True)]}</attribute>
                <attribute name="states"></attribute>
            </xpath>
        </field>
    </record>

</odoo>
