<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Project Issues tree View -->
    <record id="view_project_issue_menu_tree_inherit" model="ir.ui.view">
        <field name="name">project.issue.tree.inherit</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="abs_construction_management.view_project_issue_menu_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//tree[1]" position="attributes">
                <attribute name="multi_edit">1</attribute>
                <attribute name="sample">1</attribute>
            </xpath>
            <xpath expr="//tree/field[@name='name']" position="before">
                <field name="active" invisible="1"/>
                <field name="number"/>
            </xpath>
            <xpath expr="//tree/field[@name='job_order_id']" position="after">
                <field name="contract_id"/>
                <field name="issue_stage_name" invisible="1"/>
                <field name="issue_found_date"/>
                <field name="issue_stage_id"/>
            </xpath>
            <xpath expr="//tree/field[@name='supplier_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id="view_project_issue_menu_form_inherit_2" model="ir.ui.view">
        <field name="name">project.issue.form.inherit.2</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="abs_construction_management.view_project_issue_menu_form"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet/group/group[1]/field[@name='issue_type_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//sheet/group/group[1]/field[@name='issue_type_id']" position="after">
                <field name="issue_stage_id" invisible="1"/>
            </xpath>
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="attrs">{'readonly' : ['|',('issue_stage_id', '=', 2), ('issue_stage_id', '=', 3)]}</attribute>
            </xpath>
            <xpath expr="//field[@name='project_id']" position="attributes">
                <attribute name="attrs">{'readonly' : ['|',('issue_stage_id', '=', 2), ('issue_stage_id', '=', 3)]}</attribute>
            </xpath>
            <xpath expr="//field[@name='project_id']" position="attributes">
                <attribute name="domain">[('primary_states','=', 'progress')]</attribute>
            </xpath>
            <xpath expr="//field[@name='job_order_id']" position="attributes">
                <attribute name="attrs">{'readonly' : ['|',('issue_stage_id', '=', 2), ('issue_stage_id', '=', 3)]}</attribute>
            </xpath>
            <xpath expr="//field[@name='user_id']" position="attributes">
                <attribute name="attrs">{'readonly' : [('issue_stage_id', '=', 3)]}</attribute>
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <!-- Project Issues form View -->
    <record id="view_project_issue_menu_form_inherit" model="ir.ui.view">
        <field name="name">project.issue.form.inherit</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="abs_construction_management.view_project_issue_menu_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header/button[@name='create_bill']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//header/button[@name='create_bill']" position="after">
                <button name="action_in_progress" type="object" string="In Progress" class="oe_highlight" attrs="{'invisible': [('issue_stage_name', '!=', 'Found')]}"/>
                <button name="action_solved" type="object" string="Solved" class="oe_highlight" attrs="{'invisible': [('issue_stage_name', '!=', 'In Progress')]}"/>
                <button name="action_cancel" type="object" string="Cancel" class="btn btn-secondary" attrs="{'invisible': ['|', ('issue_stage_name', '=', 'Solved'), ('issue_stage_name', '=', 'Cancelled')]}"/>
            </xpath>
            <xpath expr="//sheet/group/group[2]/field[@name='supplier_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//notebook/page[1]" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//notebook/page[2]/field[@name='description']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//sheet/div[@name='button_box']" position="after"> 
                <div class="oe_title oe_left">
                    <h1>
                        <field name="number"/>
                    </h1>
                </div>
                <field name="active" invisible="1"/>
            </xpath>

            <xpath expr="//sheet/group/group[1]/field[@name='job_order_id']" position="after">
                <field name="issue_type_id" required = '1' attrs="{'readonly' : ['|', '|', ('issue_stage_id', '=', 2), ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}"/>
                <field name="issue_stage_id" invisible="1"/>
                <field name="priority" required = '1' attrs="{'readonly' : ['|', '|', ('issue_stage_id', '=', 2), ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}"/>
                <field name="tag_ids" widget='many2many_tags' attrs="{'readonly' : ['|', ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}"/>
                <field name="department_type" invisible="1"/>
            </xpath>

            <xpath expr="//sheet/group/group[1]/field[@name='project_id']" position="attributes">
                <attribute name="options">{'no_create': True, 'no_quick_create':True,'no_create_edit':True}</attribute>
            </xpath>

            <xpath expr="//sheet/group/group[1]/field[@name='project_id']" position="after">
                <field name="contract_id" attrs="{'readonly' : ['|', '|', ('issue_stage_id', '=', 2), ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}"/>
            </xpath>
            
            <xpath expr="//sheet/group/group[2]/field[@name='create_date']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//sheet/group/group[2]/field[@name='user_id']" position="after">
                <field name="issue_stage_name" invisible="1"/>
                <field name="employee_ids" widget="many2many_tags" attrs="{'readonly' : ['|', ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}"/>
                <field name="issue_found_date" required="1" widget='date' attrs="{'readonly' : ['|', '|', ('issue_stage_id', '=', 2), ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}"/>
                <field name="issue_solved_date" widget='date' attrs="{'readonly' : ['|', ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}"/>
                <field name="company_id" readonly="1"/>
                <field name="branch_id" required="1"/>
                <field name="create_uid" string='Created By'/>
                <field name="create_date" string='Creation Date'/>
                <field name="is_timesheet" invisible="1"/>
            </xpath>

            <xpath expr="//notebook/page[2]/field[@name='description']" position="after">
                <field name="description_new" nolabel = "1" />
            </xpath>

            <xpath expr="//notebook/page[2]" position="after">
                <page name="attachment_ids" string="Attachments" >
                    <field name="attachment_ids" class="o_attachment_line"  widget="one2many_list">
                        <tree editable="bottom">
                            <control>
                                <create name="add_product_control" string="Add a attachment"/>
                            </control>
                            <field name="sequence" invisible="1"/>
                            <field name="sr_no" />
                            <field name="date" widget='date' />
                            <field name="attachment" required="1" filename="name"/>
                            <field name="name" />
                            <field name="size" invisible="1"/>
                            <field name="description"/>
                        </tree>
                    </field>
                </page>
                <page name="timesheet_ids" string="Timesheets" attrs="{'invisible' : [('is_timesheet', '=', False)]}">
                    <field name="timesheet_ids" widget="one2many_list"  attrs="{'readonly' : ['|', '|', ('issue_stage_id', '=', 1), ('issue_stage_id', '=', 3), ('issue_stage_id', '=', 4)]}">
                        <tree editable="bottom">
                            <control>
                                <create name="add_product_control" string="Add a timesheet"/>
                            </control>
                            <field name="issue" invisible="1"/>
                            <field name="sr_no"/>
                            <field name="date" required="1"/>
                            <field name="employee_id" required="1" widget='many2many_tags'/>
                            <field name="name" />
                            <field name="unit_amount"/>
                        </tree>
                    </field>
                </page>
                <page name="extra_info" string="Extra Info" >
                    <group>
                        <group attrs="{'invisible' : [('is_timesheet', '=', False)]}">
                            <label for="days_since_last_action" string="Days Since The Last Action"/> 
                            <div class="d-flex">
                                <field name="days_since_last_action" readonly="1"/>
                                <span class="oe_inline o_form_label mx-3 oe_read_only"> Days </span>
                                <span class="oe_inline o_form_label mx-3 oe_edit_only"> Days </span>
                            </div>
                        </group>
                        <group attrs="{'invisible' : [('is_timesheet', '=', False)]}">
                            <label for="working_hours_to_solve" string="Working Hours to Solve"/> 
                            <div class="d-flex">
                                <field name="working_hours_to_solve" readonly="1"/>
                                <span class="oe_inline o_form_label mx-3 oe_read_only"> Hours </span>
                                <span class="oe_inline o_form_label mx-3 oe_edit_only"> Hours </span>
                            </div>
                        </group>
                        <group>
                            <label for="days_since_issue_found" string="Days Since Issue Found"/> 
                            <div class="d-flex">
                                <field name="days_since_issue_found" readonly="1"/>
                                <span class="oe_inline o_form_label mx-3 oe_read_only"> Days </span>
                                <span class="oe_inline o_form_label mx-3 oe_edit_only"> Days </span>
                            </div>
                        </group>
                        <group>
                        </group>
                        <group>
                            <label for="days_since_create_date" string="Days Since Creation Date"/> 
                            <div class="d-flex">
                                <field name="days_since_create_date" readonly="1"/>
                                <span class="oe_inline o_form_label mx-3 oe_read_only"> Days </span>
                                <span class="oe_inline o_form_label mx-3 oe_edit_only"> Days </span>
                            </div>
                        </group>
                    </group>
                </page>
            </xpath>
            
            <!-- logmail -->
            <xpath expr="//form/sheet[1]" position="after">
                <div class="oe_chatter" name="chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </xpath>

        </field>
    </record>

    <record id="view_project_issue_menu_form_inherit2" model="ir.ui.view">
        <field name="name">project.issue.form.inherit2</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="abs_construction_management.view_project_issue_menu_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header/button[@name='create_bill']" position="after">
                <field name="issue_stage_id" widget="statusbar" options="{'fold_field': 'fold'}"/>
            </xpath>
        </field>
    </record>

    <record id="view_project_issue_menu_form_inherit2_change" model="ir.ui.view">
        <field name="name">project.issue.form.inherit2.change</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="view_project_issue_menu_form_inherit2"/>
        <field name="arch" type="xml">
            <xpath expr="//header/field[@name='issue_stage_id']" position="replace">
                <field name="state" widget="statusbar" statusbar_visible="found,in_progress,solved,cancelled"/>
            </xpath>
        </field>
    </record>

    <record id="view_project_issue_menu_filter_inherit" model="ir.ui.view">
        <field name="name">project.issue.select.inherit</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="abs_construction_management.view_project_issue_menu_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search/group[@name='group_by']/filter[@name='supplier_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//search/group[@name='group_by']/filter[@name='supplier_id']" position="after">
                <filter name="priority" string="Priority" domain="[]" context="{'group_by' : 'priority'}" />
                <filter name="issue_found_date" string="Issue Found Date" domain="[]" context="{'group_by' : 'issue_found_date'}" />
                <filter name="issue_solved_date" string="Issue Solve Date" domain="[]" context="{'group_by' : 'issue_solved_date'}" />
            </xpath>
            
        </field>
    </record>

    <!-- project.issue kanban view -->
    <record id="project_issue_view_kanban" model="ir.ui.view">
        <field name="name">project.issue.view.kanban</field>
        <field name="model">project.issue</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="issue_stage_id" js_class="crm_kanban" sample="1" string="Project Issue Kanban">
                <field name="issue_stage_id"/>
                <field name="name"/>
                <field name="project_id"/>
                <field name="issue_type_id"/>
                <field name="priority"/>
                <templates>
                    <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_global_click">
                                <div class="o_dropdown_kanban dropdown">
                                    <a class="dropdown-toggle o-no-caret btn" role="button" data-toggle="dropdown" data-display="static" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                        <span class="fa fa-ellipsis-v"/>
                                    </a>
                                    <div class="dropdown-menu" role="menu">
                                        <t t-if="widget.editable"><a role="menuitem" type="edit" class="dropdown-item">Edit</a></t>
                                        <t t-if="widget.deletable"><a role="menuitem" type="delete" class="dropdown-item">Delete</a></t>
                                        <ul class="oe_kanban_colorpicker" data-field="color"/>
                                    </div>
                                </div>
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_title">
                                        <strong><field name="name"/></strong>
                                    </div>
                                    <div>
                                        <field name="issue_type_id"/>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <field name="priority" widget="priority" groups="base.group_user"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="oe_clear"/>
                            </div>
                        </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="abs_construction_management.action_view_project_issue_menu" model="ir.actions.act_window">
        <field name="name">Project Issue</field>
        <field name="res_model">project.issue</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_id" ref="project_issue_view_kanban"/>
        <field name="domain">[('department_type', '=', 'project')]</field>
        <field name="context">{'default_department_type': 'project'}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No Project Issue found. Let's create one!
            </p>
        </field>
    </record>

    <!-- Project Note -->
    <record id="abs_construction_management.view_project_notes_menu_tree" model="ir.ui.view">
        <field name="name">project.notes.tree</field>
        <field name="model">project.notes</field>
        <field name="arch" type="xml">
            <tree multi_edit="1" sample="1">
                <field name="project_id"/>
                <field name="tag_ids" widget = "many2many_tags"/>
                <field name="user_id"/>
            </tree>
        </field>        
    </record>

    <record id="view_project_notes_menu_form_inherit" model="ir.ui.view">
        <field name="name">project.notes.form</field>
        <field name="model">project.notes</field>
        <field name="inherit_id" ref="abs_construction_management.view_project_notes_menu_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='user_id']" position="after">
                <field name="company_id" readonly="1" force_save="1"/>
            </xpath>
            <xpath expr="//field[@name='tag_ids']" position="after">
                <field name="department_type" invisible="1"/>
            </xpath>
        </field>
    </record>

    <record id="abs_construction_management.action_view_project_notes_menu" model="ir.actions.act_window">
        <field name="name">Project Notes</field>
        <field name="res_model">project.notes</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="abs_construction_management.view_project_notes_menu_tree" />
        <field name="domain">[('department_type', '=', 'project')]</field>
        <field name="context">{'default_department_type': 'project'}</field>
        <field name="target">current</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No Project Note found. Let's create one!
            </p>
        </field>
    </record>


</odoo>
