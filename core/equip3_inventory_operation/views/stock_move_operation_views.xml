<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="inherit_view_stock_move_line_operation_tree" model="ir.ui.view">
        <field name="name">stock.move.view.stock.move.line.operation.tree.inherit</field>
        <field name="model">stock.move.line</field>
        <field name="inherit_id" ref="stock.view_stock_move_line_operation_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='product_uom_qty']" position="after">
                <field name="tracking" optional="hide"/>
            </xpath>
            <xpath expr="//field[@name='product_uom_id']" position="attributes">
                <attribute name="attrs">{'readonly': ['|', '|', ('product_uom_qty', '!=', 0.0), '&amp;', ('package_level_id', '!=', False), ('parent.picking_type_entire_packs', '=', True),('picking_code','in', ['outgoing', 'incoming'])]}</attribute>
                <attribute name="force_save">1</attribute>
            </xpath>
            <xpath expr="//field[@name='lot_id']" position="attributes">
                <attribute name="options">{'no_create': context.get('disable_create_lots_m2o', False), 'no_create_edit': context.get('disable_create_lots_m2o', False)}</attribute>
                <attribute name="attrs">{
                    'readonly': ['&amp;', ('package_level_id', '!=', False), ('parent.picking_type_entire_packs', '=', True)], 
                    'required': [('parent.picking_code', 'in', ['internal', 'outgoing'])]}
                </attribute>
                <attribute name="domain">lot_id_domain</attribute>
            </xpath>
            <xpath expr="//field[@name='lot_id']" position="after">
                <field name="lot_id_domain" invisible="1"/>
            </xpath>
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-danger">qty_done &gt; product_uom_qty and state != 'done' and picking_code != 'incoming' or product_uom_qty==qty_done</attribute>
                <attribute name="decoration-success"></attribute>
            </xpath>
            <xpath expr="//tree/field[@name='location_dest_id']" position="before">
                <field name="sequence" invisible="1"/>
                <field name="move_line_sequence"/>
                <field name="quant_package_ids" invisible="1"/>
            </xpath>
            <field name="result_package_id" position="attributes">
                <attribute name="attrs">{'readonly': ['|', '&amp;', ('package_level_id', '!=', False), ('parent.picking_type_entire_packs', '=', True), ('picking_code', '=', 'incoming')]}</attribute>
            </field>
            <xpath expr="//tree/field[@name='result_package_id']" position="attributes">
                <attribute name='domain'>[('id', 'in', quant_package_ids)]</attribute>
            </xpath>
            <xpath expr="//field[@name='owner_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id="inherit_view_stock_move_nosuggest_operations_new" model="ir.ui.view">
        <field name="name">stock.move.view.stock.move.nosuggest.operation.inherited.view.inherit</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_stock_move_nosuggest_operations"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='move_line_nosuggest_ids']" position="attributes">
                <attribute name="context">{'tree_view_ref': 'stock.view_stock_move_line_operation_tree','default_picking_id': picking_id, 'default_move_id': id, 'default_product_id': product_id, 'default_location_id': location_id, 'default_location_dest_id': location_dest_id, 'default_company_id': company_id, 'move_line_nosuggest_ids': move_line_nosuggest_ids}</attribute>
                <!-- <attribute name="attrs">{'readonly': ['|', '|', ('state', '=', 'cancel'), '&amp;', ('state', '=', 'done'), ('is_locked', '=', True), '|', ('is_serial_auto', '=', True), ('is_lot_auto', '=', True)]}</attribute> -->
                <attribute name="attrs">{'readonly': ['|', ('state', '=', 'cancel'), '&amp;', ('state', '=', 'done'), ('is_locked', '=', True)]}</attribute>
            </xpath>
            <xpath expr="//field[@name='move_line_nosuggest_ids']" position="before">
                <field name="is_serial_auto" invisible="1"/>
                <field name="has_tracking" invisible="1"/>
                <div class="action_upload_template d-inline-flex" role="alert" attrs="{'invisible': [('has_tracking', '!=', 'lot')]}" invisible="context.get('show_upload_file', True)">
                    <span class="d-inline-flex">
                        <field name="is_lot_auto" invisible="1"/>
                        <field name="export_file" filename="export_name" nolabel="1"/>
                        <button name="import_file_data" class="oe_highlight" type="object" string="Import" style="left: 265px; top: 195px; position: absolute;" attrs="{'invisible': ['|', '|', ('is_import', '=', False), ('has_tracking', '!=', 'lot'), ('is_lot_auto', '=', True)]}"/>
                        <button name="import_file_data" class="oe_highlight" type="object" string="Import" style="left: 265px; top: 188px; position: absolute;" attrs="{'invisible': ['|', '|', ('is_import', '=', False), ('has_tracking', '!=', 'lot'), ('is_lot_auto', '=', False)]}"/>
                    </span>
                    <field name="export_name" invisible="1"/>
                    <span style="margin-top: 6px;margin-left: 80px;">Don't have the template?</span>
                    <a
                        href="/equip3_inventory_operation/static/sample_data/lot_serial_num.xlsx"
                        target="_blank"
                        style="margin-top: 6px;margin-left: 7px;">
                        <div class="download_template_form">
                            <strong>Download The Template</strong>
                            <field name="is_import" invisible="1"/>
                        </div>
                    </a>
                </div>
            </xpath>
        </field>
    </record>

<record id="inherited_view_stock_move_operations" model="ir.ui.view">
    <field name="name">stock.move.view.view_stock_move_operations</field>
    <field name="model">stock.move</field>
    <field name="inherit_id" ref="stock.view_stock_move_operations"/>
    <field name="arch" type="xml">
        <!-- WRAP ALL ELEMENTS INTO SHEET -->
        <xpath expr="//field[@name='sequence']" position="before">
            <sheet></sheet>
        </xpath>
        <xpath expr="//form/sheet" position="inside">
            <xpath expr="//group" position="move"/>
            <xpath expr="//field[@name='move_line_ids']" position="move"/>
        </xpath>
        <xpath expr="//field[@name='next_serial']" position="replace"/>
        <xpath expr="//label[@for='next_serial_count']" position="replace"/>
        <xpath expr="//field[@name='next_serial_count']/parent::span//parent::div" position="replace"/>

        <!-- ADD INVISIBLE FIELDS HERE -->
        <xpath expr="//field[@name='display_assign_serial']" position="after">
            <field name="has_tracking" invisible="1"/>
            <field name="is_serial_auto" invisible="1"/>
            <field name="is_lot_auto" invisible="1"/>
            <field name="picking_code" invisible="1"/>
            <field name="display_assign" invisible="1"/>
        </xpath>

        <xpath expr="//field[@name='move_line_ids']" position="before">
            <div attrs="{'invisible': [('has_tracking', '=', 'lot')]}" class="action_upload_template d-inline-flex" role="alert" invisible="context.get('show_upload_file', True)">
                <span class="d-inline-flex">
                    <field name="export_file" filename="export_name" nolabel="1"/>
                    <button name="import_file_data" class="oe_highlight" type="object" string="Import" style="left: 265px; top: 190px; position: absolute;" attrs="{'invisible': ['|', '|', ('is_import', '=', False), ('is_serial_auto', '=', False), ('has_tracking', '=', 'lot')]}"/>
                    <button name="import_file_data" class="oe_highlight" type="object" string="Import" style="left: 265px; top: 195px; position: absolute;" attrs="{'invisible': ['|', '|', ('is_import', '=', False), ('is_serial_auto', '=', True), ('has_tracking', '=', 'lot')]}"/>
                </span>
                <field name="export_name" invisible="1"/>
                <span style="margin-top: 6px;margin-left: 80px;">Don't have the template?</span>
                <a
                    href="/equip3_inventory_operation/static/sample_data/serial_num.xlsx"
                    target="_blank"
                    style="margin-top: 6px;margin-left: 7px;">
                    <div class="download_template_form">
                        <strong>Download The Template</strong>
                        <field name="is_import" invisible="1"/>
                    </div>
                </a>
            </div>
        </xpath>

        <xpath expr="//form/sheet/group" position="after">
            <group>
                <group name="lot_serializer" string="Lots Serializer" attrs="{'invisible': ['|', ('display_assign', '!=', True), ('has_tracking', '!=', 'lot')]}">
                    <field name="package_quant_ids" widget="many2many_tags" invisible="1"/>
                    <field name="next_lot" string="Fisrt Lot Number" attrs="{'invisible': [('is_lot_auto', '=', True)]}"/>
                    <field name="qty_per_lot" string="Quantity Per Lot"/>
                    <field name="next_lot_count" string="Quantity To Serialize" readonly="1" force_save="1"/>
                    <div class="o_row">
                        <button name="action_assign_lot_show_details" type="object" class="btn-link">
                            <span class="font-weight-bold">Assign Lot Numbers</span>
                        </button>
                        <button name="action_clear_lines_show_details" type="object" class="btn-link">
                            <span class="font-weight-bold">Clear All</span>
                        </button>
                        <span class="font-weight-bold">or</span>
                        <button name="action_import_template" type="object" class="btn-link" title="Import">
                            <span class="font-weight-bold">Import</span>
                        </button>
                    </div>
                </group>

                <group name="serial_serializer" string="Serial Numbers Serializer" attrs="{'invisible': ['|', ('display_assign', '!=', True), ('has_tracking', '!=', 'serial')]}">
                    <field name="next_serial" string="First Serial Number" attrs="{'invisible': [('is_serial_auto', '=', True)]}"/>
                    <field name="next_serial_count" string="Quantity To Serialize"/>
                    <div class="o_row">
                        <button name="action_assign_serial_show_details" type="object" class="btn-link">
                            <span class="font-weight-bold">Assign Serial Numbers</span>
                        </button>
                        <button name="action_clear_lines_show_details" type="object" class="btn-link">
                            <span class="font-weight-bold">Clear All</span>
                        </button>
                        <span class="font-weight-bold">or</span>
                        <button name="action_import_template" type="object" class="btn-link" title="Import">
                            <span class="font-weight-bold">Import</span>
                        </button>
                    </div>
                </group>

                <group name="packages" string="Packages" attrs="{'invisible': [('picking_code', '!=', 'incoming')]}">
                    <field name="package_type" domain="[('id', 'in', packaging_ids)]" groups="stock.group_tracking_lot"/>
                    <field name="package_measure_selection" invisible="1"/>
                    <field name="measure_ids" widget="many2many_tags" options="{'no_create_edit':'1'}"/>
                    <field name="packaging_ids" domain="[('id', 'in', packaging_ids)]" widget="one2many_tags" string="Package Measured By" invisible="1"/>
                    <field name="qty_in_pack" groups="stock.group_tracking_lot"/>
                    <field name="is_existing_package"/>
                    <field name="move_package_id" attrs="{'invisible': [('is_existing_package', '=', False)]}" domain="[('id', 'in', filter_move_package_ids)]"/>
                    <field name="filter_move_package_ids" invisible="1"/>
                    <button name="action_put_in_package" class="oe_highlight" type="object" string="Put In Package" groups="stock.group_tracking_lot"/>
                </group>

                <group name="barcode" string="Barcode Scanner">
                    <label for="sh_stock_move_barcode_mobile"/>
                    <div class="o_row">
                        <field name="sh_stock_move_barcode_mobile"/>
                        <a role="button" class="btn btn-primary oe_edit_only o_mbs_start_button" id="js_id_sh_stock_move_barcode_mobile_start_btn">
                            <i class="fa fa-barcode"></i> Start
                        </a>
                        <a role="button" style="display: none;" class="btn btn-danger oe_edit_only o_mbs_stop_button" id="js_id_sh_stock_move_barcode_mobile_reset_btn">
                            <i class="fa fa-barcode"></i> Stop
                        </a>
                    </div>
                    <field name="sh_stock_move_bm_is_cont_scan"/>
                </group>
            </group>
        </xpath>
        <xpath expr="//field[@name='quantity_done']/../.." position="after">
            <field name="fulfillment" invisible="1"/>
        </xpath>
    </field>
    </record>

    <record id="sh_inventory_barcode_mobile_stock_move_operations" model="ir.ui.view">
        <field name="name">sh.inventory.barcode.mobile.stock.move.operations</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="sh_all_in_one_mbs.sh_inventory_barcode_mobile_stock_move_operations"/>
        <field name="arch" type="xml">
            <xpath expr="//label[@for='sh_stock_move_barcode_mobile']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='sh_stock_move_barcode_mobile']/parent::div" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='sh_stock_move_bm_is_cont_scan']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id="inherit_view_stock_move_line_detailed_operation_tree" model="ir.ui.view">
        <field name="name">stock.move.view.stock.move.line.detailed.operation.tree.inherit</field>
        <field name="model">stock.move.line</field>
        <field name="inherit_id" ref="stock.view_stock_move_line_detailed_operation_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-danger">qty_done&gt;product_uom_qty and state!='done' and parent.picking_type_code != 'incoming' or qty_done==product_uom_qty and state!='done' and not result_package_id</attribute>
                <attribute name="decoration-success"></attribute>
            </xpath>
            <xpath expr="//field[@name='lot_id']" position="after">
                <field name="product_type" invisible="1"/>
            </xpath>
            <xpath expr="//field[@name='qty_done']" position="attributes">
                <attribute name="attrs">{'readonly': [('product_type', '=', 'service')]}</attribute>
            </xpath>
        </field>
    </record>

    <record id="inherit_view_stock_view_picking_form_new" model="ir.ui.view">
        <field name="name">stock.view.picking.form.inherit.new</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            <xpath expr="//page[@name='operations']//field[@name='move_ids_without_package']//tree//field[@name='forecast_availability']" position="after">
                <field name="product_type" invisible="1"/>
            </xpath>
            <xpath expr="//page[@name='operations']//field[@name='move_ids_without_package']//tree//field[@name='product_uom_qty']" position="before">
                <field name="initial_demand" force_save="1" readonly="1"/>
                <field name="remaining" readonly="1" force_save="1"/>
            </xpath>
            <xpath expr="//page[@name='operations']//field[@name='move_ids_without_package']//tree//field[@name='quantity_done']" position="attributes">
                <attribute name="attrs">{'readonly': ['|', '&amp;', ('is_adjustable_picking', '=', True), ('picking_state', 'in', ('done', 'cancel','draft')), '&amp;', ('is_adjustable_picking', '=', False), ('picking_state', '=', 'draft')]}</attribute>
            </xpath>
            <xpath expr="//page[@name='operations']//field[@name='move_ids_without_package']//tree//field[@name='product_uom_qty']" position="attributes">
                <attribute name="attrs">{'column_invisible': [('parent.immediate_transfer', '=', True)], 'readonly': ['|', '&amp;', ('is_adjustable_picking', '=', True), ('picking_state', 'in', ('done', 'cancel')), '&amp;', ('is_adjustable_picking', '=', False), ('picking_state', '!=', 'draft')]}</attribute>
            </xpath>
            <xpath expr="//field[@name='product_uom']" position="attributes">
                <!-- <attribute name="attrs">{'readonly': ['|', ('parent.transfer_id', '!=', False), ('state', '!=', 'draft'), ('additional', '=', False)]}</attribute> -->
                <!-- <attribute name="attrs">{'readonly': [
                    '|',
                    ('parent.transfer_id', '!=', False),
                    ('picking_code', '!=', 'outgoing'),
                    ('parent.state', 'in', ('assigned','done','cancel')),
                    ('additional', '=', False)
                ]}</attribute> -->
                <attribute name="attrs">{'readonly': [
                    ('picking_code', '=', 'incoming'),
                    ('parent.state', 'in', ('done','cancel')),
                    ('additional', '=', False)
                ]}</attribute>
            </xpath>
            <xpath expr="//page[@name='operations']//field[@name='move_ids_without_package']//tree//field[@name='quantity_done']" position="after">
               <field name="is_product_service_operation" invisible="1"/>
               <field name="is_product_service_operation_delivery" invisible="1"/>
               <field name="is_product_service_operation_receiving" invisible="1"/>
               <field name="move_progress" widget="progressbar" nolabel="1" attrs="{'invisible': [('product_type', '!=', 'service')]}"/>
               <button name="action_full_quantity_done" type="object" class="oe_highlight" string="Full" attrs="{'invisible': [('product_type', '!=', 'service')]}"/>
               <button name="action_partial_quantity_done" type="object" class="oe_highlight" string="Partial" attrs="{'invisible': [('product_type', '!=', 'service')]}"/>
               <field name="product_uom" position="move"/>
               <field name="fulfillment" readonly="1" force_save="1"/>
            </xpath>
        </field>
    </record>

    <record id="view_inventory_operation_move_search" model="ir.ui.view">
        <field name="name">view.inventory.operation.move.search</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_search"/>
        <field name="arch" type="xml">
            <xpath expr="//search/filter" position="before">
                <filter string="Sales Return" name="sales_return" domain="[('location_id','=','Partner Locations/Customers')]"/>
                <filter string="Purchase Return" name="purchase_return" domain="[('location_dest_id','=','Partner Locations/Vendors')]"/>
                <filter string="Internal Transfer Return" name="internal_transfer_return" domain="[('picking_type_code','=','internal')]"/>
                <separator/>
            </xpath>
        </field>
    </record>
    
    <record id="view_move_form_inherit_invisible_group_id" model="ir.ui.view">
        <field name="name">view.inventory.operation.move.search</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='group_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>
</odoo>
